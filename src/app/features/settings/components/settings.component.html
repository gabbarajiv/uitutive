<div class="settings-container">
    <app-page-header title="Settings (Configure)" icon="tune"
        description="Manage your application preferences, theme, and AI model configuration.">
    </app-page-header>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-message">
        <mat-icon>error_outline</mat-icon>
        <span>{{ errorMessage }}</span>
    </div>

    <div class="settings-content">
        <!-- Theme Settings -->
        <mat-card class="settings-card">
            <mat-card-header>
                <mat-icon class="section-icon">palette</mat-icon>
                <h2>Theme Settings</h2>
            </mat-card-header>
            <mat-divider></mat-divider>
            <mat-card-content>
                <div class="setting-item">
                    <div class="setting-label">
                        <h3>Application Theme</h3>
                        <p class="description">Choose your preferred theme color scheme</p>
                    </div>
                    <mat-form-field appearance="outline" class="theme-select">
                        <mat-label>Theme</mat-label>
                        <mat-select [value]="currentTheme" (selectionChange)="changeTheme($event.value)">
                            <mat-option *ngFor="let theme of availableThemes" [value]="theme">
                                {{ theme | titlecase }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <mat-divider class="inner-divider"></mat-divider>

                <div class="setting-item">
                    <div class="setting-label">
                        <h3>Header Theme</h3>
                        <p class="description">Customize your header appearance with different themes</p>
                    </div>
                    <mat-form-field appearance="outline" class="theme-select">
                        <mat-label>Header Theme</mat-label>
                        <mat-select [value]="currentHeaderTheme" (selectionChange)="changeHeaderTheme($event.value)">
                            <mat-option *ngFor="let theme of availableHeaderThemes" [value]="theme">
                                {{ getHeaderThemeLabel(theme) }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <mat-divider class="inner-divider"></mat-divider>

                <div class="setting-item">
                    <div class="setting-label">
                        <h3>Theme Preview</h3>
                        <p class="description">Preview of current theme colors</p>
                    </div>
                    <div class="theme-preview">
                        <div class="color-swatch" [style.background-color]="'var(--color-primary)'">
                            <span>Primary</span>
                        </div>
                        <div class="color-swatch" [style.background-color]="'var(--color-secondary)'">
                            <span>Secondary</span>
                        </div>
                        <div class="color-swatch" [style.background-color]="'var(--color-accent)'">
                            <span>Accent</span>
                        </div>
                        <div class="color-swatch" [style.background-color]="'var(--color-success)'">
                            <span>Success</span>
                        </div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- API Settings -->
        <mat-card class="settings-card">
            <mat-card-header>
                <mat-icon class="section-icon">api</mat-icon>
                <h2>AI Configuration</h2>
            </mat-card-header>
            <mat-divider></mat-divider>
            <mat-card-content>
                <div class="setting-item">
                    <div class="setting-label">
                        <h3>OpenAI API Key</h3>
                        <p class="description">Configure your OpenAI API key for form generation</p>
                    </div>
                    <div class="api-key-container">
                        <mat-form-field appearance="outline" class="api-input">
                            <mat-label>API Key</mat-label>
                            <input matInput [type]="showApiKey ? 'text' : 'password'" [(ngModel)]="apiKey"
                                placeholder="sk-...">
                            <button mat-icon-button matSuffix (click)="toggleApiKeyVisibility()" type="button">
                                <mat-icon>{{ showApiKey ? 'visibility_off' : 'visibility' }}</mat-icon>
                            </button>
                        </mat-form-field>
                        <button mat-raised-button color="primary" (click)="saveApiKey()"
                            [disabled]="!apiKey || apiKey.startsWith('••••••••')">
                            <mat-icon>save</mat-icon>
                            Save
                        </button>
                        <button mat-stroked-button (click)="clearApiKey()" [disabled]="!apiKey">
                            <mat-icon>delete</mat-icon>
                            Clear
                        </button>
                    </div>
                </div>

                <mat-divider class="inner-divider"></mat-divider>

                <div class="setting-item">
                    <div class="setting-label">
                        <h3>AI Model</h3>
                        <p class="description">Select the AI model to use for form generation</p>
                    </div>
                    <div class="model-selector">
                        <mat-form-field appearance="outline" class="model-select">
                            <mat-label>Model</mat-label>
                            <mat-select [value]="currentModel" (selectionChange)="changeModel($event.value)"
                                [disabled]="loadingModels || modelChangeInProgress" [compareWith]="compareModels">
                                <mat-option *ngIf="loadingModels" disabled>
                                    <mat-icon>hourglass_empty</mat-icon>
                                    Loading models...
                                </mat-option>
                                <mat-option *ngFor="let model of availableModels" [value]="model.name">
                                    {{ model.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-icon *ngIf="modelChangeInProgress" class="spinner">
                            <mat-spinner diameter="20"></mat-spinner>
                        </mat-icon>
                    </div>
                </div>

                <mat-divider class="inner-divider"></mat-divider>

                <div class="setting-item">
                    <div class="setting-label">
                        <h3>API Status</h3>
                        <p class="description">Connection status to AI services</p>
                    </div>
                    <div class="status-badge" [class.active]="apiKey && !apiKey.startsWith('••••••••')">
                        <mat-icon>{{ apiKey && !apiKey.startsWith('••••••••') ? 'check_circle' : 'error' }}</mat-icon>
                        <span>{{ apiKey && !apiKey.startsWith('••••••••') ? 'Configured' : 'Not Configured' }}</span>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- General Settings -->
        <mat-card class="settings-card">
            <mat-card-header>
                <mat-icon class="section-icon">tune</mat-icon>
                <h2>General Settings</h2>
            </mat-card-header>
            <mat-divider></mat-divider>
            <mat-card-content>
                <div class="setting-item">
                    <div class="setting-label">
                        <h3>Clear All Settings</h3>
                        <p class="description">Reset all settings back to their default values</p>
                    </div>
                    <button mat-stroked-button color="warn" (click)="resetToDefaults()"
                        [matTooltip]="'This action cannot be undone'">
                        <mat-icon>refresh</mat-icon>
                        Reset to Defaults
                    </button>
                </div>

                <mat-divider class="inner-divider"></mat-divider>

                <div class="setting-item">
                    <div class="setting-label">
                        <h3>Export Settings</h3>
                        <p class="description">Download your settings as a JSON file</p>
                    </div>
                    <button mat-stroked-button (click)="exportSettings()"
                        [matTooltip]="'Save settings for backup or transfer'">
                        <mat-icon>download</mat-icon>
                        Export
                    </button>
                </div>

                <mat-divider class="inner-divider"></mat-divider>

                <div class="setting-item">
                    <div class="setting-label">
                        <h3>Import Settings</h3>
                        <p class="description">Load settings from a previously exported JSON file</p>
                    </div>
                    <div class="import-container">
                        <input type="file" #fileInput hidden accept=".json" (change)="importSettings($event)" />
                        <button mat-stroked-button (click)="fileInput.click()"
                            [matTooltip]="'Load settings from a file'">
                            <mat-icon>upload</mat-icon>
                            Import
                        </button>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Prompt Suggestions Settings -->
        <mat-card class="settings-card">
            <mat-card-header>
                <mat-icon class="section-icon">lightbulb_outline</mat-icon>
                <h2>Prompt Suggestions</h2>
            </mat-card-header>
            <mat-divider></mat-divider>
            <mat-card-content>
                <p class="section-description">Manage configurable prompt suggestions that appear in the form generator.
                    Users can click these suggestions to quickly populate the input field.</p>

                <!-- Add New Suggestion -->
                <div class="suggestion-form">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Add a new suggestion</mat-label>
                        <textarea matInput [(ngModel)]="newSuggestion"
                            placeholder="e.g., Create a customer feedback form with rating and comments"
                            rows="2"></textarea>
                        <mat-hint>Enter a form description that users might want to use</mat-hint>
                    </mat-form-field>
                    <button mat-raised-button color="primary" (click)="addPromptSuggestion()"
                        [disabled]="!newSuggestion.trim()">
                        <mat-icon>add</mat-icon>
                        Add Suggestion
                    </button>
                </div>

                <mat-divider class="inner-divider"></mat-divider>

                <!-- Current Suggestions List -->
                <div class="suggestions-list">
                    <h3 class="suggestions-title">Current Suggestions ({{ suggestions.length }})</h3>
                    <div *ngIf="suggestions.length === 0" class="empty-suggestions">
                        <mat-icon>folder_open</mat-icon>
                        <p>No suggestions yet. Add your first suggestion above.</p>
                    </div>

                    <div *ngFor="let suggestion of suggestions" class="suggestion-item">
                        <div class="suggestion-content">
                            <div *ngIf="editingSuggestionId !== suggestion.id" class="suggestion-text">
                                {{ suggestion.text }}
                            </div>
                            <div *ngIf="editingSuggestionId === suggestion.id" class="suggestion-edit">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Edit suggestion</mat-label>
                                    <textarea matInput [(ngModel)]="editingSuggestionText" rows="2"></textarea>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="suggestion-actions">
                            <button *ngIf="editingSuggestionId !== suggestion.id" mat-icon-button
                                (click)="startEditSuggestion(suggestion.id, suggestion.text)"
                                matTooltip="Edit suggestion">
                                <mat-icon>edit</mat-icon>
                            </button>
                            <button *ngIf="editingSuggestionId !== suggestion.id" mat-icon-button color="warn"
                                (click)="deletePromptSuggestion(suggestion.id)" matTooltip="Delete suggestion">
                                <mat-icon>delete</mat-icon>
                            </button>
                            <button *ngIf="editingSuggestionId === suggestion.id" mat-icon-button color="primary"
                                (click)="saveEditSuggestion()" matTooltip="Save changes">
                                <mat-icon>check</mat-icon>
                            </button>
                            <button *ngIf="editingSuggestionId === suggestion.id" mat-icon-button
                                (click)="cancelEditSuggestion()" matTooltip="Cancel editing">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                    </div>
                </div>

                <mat-divider class="inner-divider"></mat-divider>

                <!-- Reset Suggestions -->
                <div class="setting-item">
                    <div class="setting-label">
                        <h3>Reset to Defaults</h3>
                        <p class="description">Reset suggestions to their default values</p>
                    </div>
                    <button mat-stroked-button color="warn" (click)="resetSuggestionsToDefaults()"
                        [matTooltip]="'This will replace all suggestions with defaults'">
                        <mat-icon>refresh</mat-icon>
                        Reset to Defaults
                    </button>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Unsaved Changes Indicator -->
        <div *ngIf="hasUnsavedChanges" class="unsaved-indicator">
            <mat-icon>info</mat-icon>
            <span>You have unsaved changes</span>
        </div>
    </div>
</div>